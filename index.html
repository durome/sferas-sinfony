<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sferas Sinfony â€” Eduardo Romaguera (2025)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/addons/p5.sound.min.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: black;
      font-family: Helvetica, Arial, sans-serif;
    }
    #startButton {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 16px 32px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      color: white;
      font-size: 18px;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.5s ease;
    }
    #startButton:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%) scale(1.05);
    }
  </style>
</head>
<body>
  <button id="startButton" onclick="startExperience()">Iniciar experiencia sonora</button>

  <script>
    let spheres = [];
    let weather = { temperature: 20, wind: 0, humidity: 50 };
    let started = false;
    let noiseOsc, filter, lfo;

    async function fetchWeather() {
      const response = await fetch(
        "https://api.open-meteo.com/v1/forecast?latitude=39.47&longitude=-0.38&current=temperature_2m,wind_speed_10m,relative_humidity_2m"
      );
      const data = await response.json();
      weather.temperature = data.current.temperature_2m;
      weather.wind = data.current.wind_speed_10m;
      weather.humidity = data.current.relative_humidity_2m;
    }

    function setup() {
      createCanvas(windowWidth, windowHeight, WEBGL);
      colorMode(HSB, 360, 255, 255, 255);
      noStroke();
      fetchWeather();
      setInterval(fetchWeather, 60000);
    }

    function draw() {
      if (!started) return;
      background(0, 20);
      rotateY(frameCount * 0.002);

      for (let s of spheres) {
        s.update();
        s.display();
      }

      if (frameCount % 5 === 0) spheres.push(new Sphere());
      spheres = spheres.filter(s => !s.dead);

      drawSignature();
    }

    class Sphere {
      constructor() {
        this.pos = createVector(random(-300, 300), random(-300, 300), random(-300, 300));
        this.size = map(weather.temperature, -10, 40, 10, 80);
        this.speed = map(weather.wind, 0, 30, 0.1, 2);
        this.hue = map(weather.humidity, 0, 100, 180, 360);
        this.life = 255;
        this.dead = false;
      }

      update() {
        this.pos.add(p5.Vector.random3D().mult(this.speed));
        this.life -= 1;
        if (this.life < 0) this.dead = true;
      }

      display() {
        push();
        fill(this.hue, 200, 255, this.life);
        translate(this.pos.x, this.pos.y, this.pos.z);
        sphere(this.size);
        pop();
      }
    }

    // ðŸŒ«ï¸ Sonido atmosfÃ©rico â€” suave respiraciÃ³n solar
    function startSolarHum() {
      noiseOsc = new p5.Noise('pink');
      filter = new p5.LowPass();
      lfo = new p5.Oscillator('sine');
      lfo.freq(0.1);
      lfo.amp(300);
      lfo.start();

      noiseOsc.disconnect();
      noiseOsc.connect(filter);
      filter.freq(800);
      noiseOsc.amp(0.05);
      noiseOsc.start();
    }

    // âœ¨ Firma viva
    let fade = 0;
    function drawSignature() {
      fade = (sin(frameCount * 0.01) * 0.5 + 0.5) * 120 + 50;
      push();
      resetMatrix();
      translate(width - 240, height - 40);
      textAlign(RIGHT);
      textFont('Helvetica');
      textSize(14);
      fill(255, fade);
      text("Eduardo Romaguera â€” Sferas Sinfony (2025)", 0, 0);
      pop();
    }

    // ðŸ”˜ Inicio de la experiencia
    function startExperience() {
      userStartAudio();
      startSolarHum();
      started = true;
      document.getElementById("startButton").style.display = "none";
    }

    function windowResized() {
      resizeCanvas(windowWidth, windowHeight);
    }
  </script>
</body>
</html>
